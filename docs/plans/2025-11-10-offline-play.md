# Offline Play Experience Implementation Plan

## Overview

Deliver a reliable offline-capable build by introducing a Vite PWA setup that precaches the game shell/assets, surfaces connectivity state to the UI, and gracefully blocks/communicates when leaderboard or email submissions cannot reach the backend. Players should be able to launch and continue gameplay once assets are cached, while high scores and mailing-list updates wait for a reconnection.

## Current State Analysis

- The bundle exposes email capture in the info drawer (`src/main.ts:142`) and a game-over submission form (`src/ui/components/game-over-overlay.component.ts:185`) without checking `navigator.onLine`, so offline attempts fail with generic fetch errors.
- Leaderboard rendering always calls the API via `fetchLeaderboard` and, on failure, renders the generic error state (`src/ui/components/leaderboard-panel.component.ts:42`); there is no cached data or offline messaging.
- We serve a manifest already (`public/manifest.json:1`) but lack a service worker or asset precache, so the game cannot start offline unless all resources stay in the HTTP cache.

## Desired End State

The app registers a service worker generated by `vite-plugin-pwa` that precaches the Pixi bundle, CSS, manifest, icons, and static art/audio. A connectivity store tracks `online`/`offline` status and drives:
- Inline messaging within the info panel, leaderboard, and game-over overlay so players know submissions pause while offline without covering gameplay.
- Disabled submission buttons and inline guidance when offline, preventing futile POSTs.
- Leaderboard panel remaining visible but clearly noting that data is stale/unavailable until connectivity is restored.
Verification requires building the PWA, installing/refreshing, toggling offline in DevTools, and confirming gameplay continues along with the described messaging.

### Key Discoveries:
- `src/main.ts:142-185` wires the info drawer email form directly to `submitUserContact` with no connectivity checks.
- `src/ui/components/game-over-overlay.component.ts:287-327` handles score submissions entirely within the Pixi overlay; error strings bubble straight to the status text.
- `src/ui/components/leaderboard-panel.component.ts:42-159` renders loading/error/empty states but has no concept of offline or cached data.

## What We're NOT Doing

- No queueing/replay of submissions or background sync; actions are simply blocked until online.
- No redesign of leaderboard layout or scoring rules.
- No backend/API changes (only front-end UX + service worker).
- No additional analytics or telemetry around offline usage.

## Implementation Approach

Adopt `vite-plugin-pwa` to handle service worker generation, manifest integration, and precache lists while keeping production builds tree-shakable. Extend the client with a lightweight connectivity store (e.g., a singleton module exposing `isOnline()` + `subscribe`) so multiple components can respond consistently. UI changes will conditionally disable actions, show inline notices, and adjust copy, but continue rendering existing components to avoid layout jumps. Verification includes PWA audits and manual offline smoke tests.

## Phase 1: PWA Foundation

### Overview
Install and configure `vite-plugin-pwa`, register the generated service worker, and ensure builds precache static assets (JS/CSS/atlases/audio/icons). Verify dev server compatibility and that production builds pass Vite+tsc.

### Changes Required:

#### 1. Build Tooling
**File**: `package.json`, `pnpm-lock.yaml`
**Changes**: add `vite-plugin-pwa` dependency (dev).

#### 2. Vite Config
**File**: `vite.config.ts` (new)
**Changes**: move Vite settings out of inline scripts, enable `VitePWA` with:
```ts
VitePWA({
  registerType: 'autoUpdate',
  includeAssets: ['favicon.svg', 'robots.txt', 'icons/*', 'sound/**/*', 'atlases/**/*'],
  manifest: { ...existing manifest metadata or reference public/manifest.json },
  workbox: {
    globPatterns: ['**/*.{js,css,html,ico,png,svg,webp,json,mp3,ogg}'],
    runtimeCaching: [
      {
        urlPattern: /^https:\/\/[^/]+\/api\/(scores|leaderboard|users)/,
        handler: 'NetworkOnly'
      }
    ]
  }
});
```
Adjust Vite entry/aliases if needed.

#### 3. Service Worker Registration
**File**: `src/main.ts`
**Changes**: import `virtual:pwa-register` (or `virtual:pwa-register/vanilla`) and call it after bootstrapping, logging updates for debugging.

### Success Criteria:

#### Automated Verification:
- [x] Type-check + build succeeds: `npm run build`
- [x] Vite preview runs without errors: `npm run preview`
- [x] `npm run test` remains green (even if empty)

#### Manual Verification:
- [ ] Lighthouse/PWA audit reports an installable app with service worker + manifest
- [ ] After `npm run build && npm run preview`, visiting the preview registers the SW (seen in DevTools)
- [ ] Reload while offline still serves the game shell (index + JS bundle)

**Implementation Note**: Once the SW is in place, remind reviewers to hard refresh or unregister between tests to avoid stale caches.

---

## Phase 2: Connectivity State & Offline UX

### Overview
Introduce a shared connectivity store that listens to `window.addEventListener('online'|'offline')` and surface offline state inline within the app chrome. (Original banner concept was removed to avoid covering the game board; rely on contextual messaging inside forms/leaderboard instead.)

### Changes Required:

#### 1. Connectivity Store
**File**: `src/shared/state/connectivity.ts` (new)
**Changes**: expose `getConnectivityState()`, `subscribe(handler)`, `isOnline()`, internally rely on `navigator.onLine` and events.

#### 2. Bootstrap Wiring
**File**: `src/main.ts`
**Changes**: initialize the store early (before UI setups) so other modules can import without window guards. Provide a helper to query state inside Pixi scenes.

#### 3. Offline Banner _(removed)_
**Files**: `index.html`, `src/style.css`
**Changes**: Originally planned as a global DOM banner, but removed per gameplay feedback so the board remains unobstructed. Offline messaging now lives solely within the info drawer, leaderboard, and game-over overlay status text.

### Success Criteria:

#### Automated Verification:
- [x] `npm run build` still passes with new modules
- [x] `npm run preview` renders without CSS/TS errors

#### Manual Verification:
- [ ] Toggling offline in DevTools immediately disables the info-panel + game-over submit buttons and shows their inline offline copy; reconnecting restores the normal states
- [ ] Leaderboard panel shows its offline notice while retaining the latest entries, then refreshes automatically once back online
- [ ] No console errors when loading offline (connectivity store should handle DOM availability gracefully)

**Implementation Note**: Keep inline DOM helpers minimal (plain DOM rather than Pixi) so they render even before Pixi boot completes and stay out of the gameplay viewport.

---

## Phase 3: Network Feature Guardrails

### Overview
Update every network-bound UI to respect connectivity state: disable submit buttons, show inline copy explaining submissions are paused, and avoid firing fetches while offline. Leaderboard should stay visible but overlay a “offline – will refresh when reconnected” message instead of repeating fetch attempts.

### Changes Required:

#### 1. Leaderboard Panel
**File**: `src/ui/components/leaderboard-panel.component.ts`
**Changes**:
```ts
if (!connectivityStore.isOnline()) {
  this.renderOfflineNotice(container);
  return;
}
```
Add `renderOfflineNotice` to keep existing entries (maybe last-known) but show message; optionally skip `fetchLeaderboard` until online again.

#### 2. Info Panel Email Form
**File**: `src/main.ts`
**Changes**: before submission, check `isOnline`; if offline, set status message like “Offline – we’ll save as soon as you reconnect” and block fetch. Optionally disable the submit button when offline.

#### 3. Game-Over Overlay Submission
**File**: `src/ui/components/game-over-overlay.component.ts`
**Changes**: disable submit button + show `statusText` message when offline; re-enable automatically when connection returns (subscribe to connectivity store). Ensure `handleSkipClick` still works offline without hitting APIs.

#### 4. Shared Messaging
**Files**: `src/api/scores-client.ts`, `src/api/users-client.ts`, `src/api/leaderboard-client.ts`
**Changes**: optionally adjust thrown error copy to mention offline state when `!navigator.onLine`, so UI can display friendlier text even if guardrails miss a case.

### Success Criteria:

#### Automated Verification:
- [x] `npm run build` passes
- [x] Linting (if configured) reports no unused vars/imports *(no dedicated lint script; TypeScript build succeeds without unused warnings)*

#### Manual Verification:
- [ ] With DevTools offline, leaderboard area shows the offline message instead of spinners/errors
- [ ] Email form and score submit buttons become disabled and display the offline copy; they re-enable automatically when going back online without reloading
- [ ] Attempting to submit while offline produces no network requests (verified via DevTools network tab)

**Implementation Note**: Consider storing the last successful leaderboard payload in memory so going offline immediately after loading still shows standings with an “stale” badge; this is optional but improves UX.

---

## Phase 4: Testing Strategy & Regression Checks

### Overview
Finalize QA steps, update README with offline instructions, and ensure consistent developer guidance around cache busting.

### Changes Required:

#### 1. Documentation
**File**: `README.md`
**Changes**: add a “Offline / PWA” section describing install steps, how to clear SW cache, and limitations (no queued submissions).  
_Status_: Added the **Offline / PWA** section plus cache-clearing + limitation notes in `README.md`.

#### 2. Manual Test Checklist
**File**: `docs/plans/2025-11-10-offline-play.md` (this plan) or a QA doc
**Changes**: include the manual steps listed below for handoffs.  
_Status_: Checklist captured in the “Manual Testing Steps” section below for QA handoff.

### Success Criteria:

#### Automated Verification:
- [x] `npm run build` documented as required pre-merge check

#### Manual Verification:
- [ ] Fresh install path: load site online, toggle offline, reload -> still playable
- [ ] Update path: change code, rebuild, confirm service worker updates (maybe via `skipWaiting()` log)
- [ ] README accurately guides clearing SW caches (DevTools Application tab)

**Implementation Note**: Encourage devs to run `npm run preview -- --host` when testing offline on devices so service worker scope matches production hostnames.

---

## Testing Strategy

### Unit Tests:
- `ConnectivityStore` utility: verify it emits initial state and handles event listeners (`shared/state/connectivity.spec.ts`).
- Optional smoke tests for leaderboard component to ensure it renders offline state without DOM errors.

### Integration Tests:
- None automated for now; rely on browser manual testing due to Pixi + SW complexity.

### Manual Testing Steps:
1. `npm install && npm run build && npm run preview`
2. Load the app in Chrome, confirm submission controls are enabled while online (info drawer + game-over overlay).
3. Open DevTools > Application > Service Workers, verify SW registered and `autoUpdate` true.
4. Switch DevTools Network tab to “Offline”; leaderboard/email forms disable with inline “offline” copy, and the in-game overlay prevents submission.
5. Reload while still offline: app shell + gameplay operate using cached assets.
6. Return online; inline copy clears, leaderboard reloads, and forms submit successfully.

## Performance Considerations

- Precache list should stay under Workbox limits; consider chunking large audio assets or using runtime caching with `CacheFirst`.
- Service worker updates should `skipWaiting` only after new assets download to avoid race conditions mid-game.
- Avoid heavy polling for connectivity; rely on browser events + `navigator.onLine`.

## Migration Notes

- None (pure front-end). Remind deployers to invalidate CDN caches when shipping the new SW so clients fetch the updated files promptly.

## References

- Original request: “make game playable offline… show state that it'll be submitted/updated once connection is established” (CLI prompt)
- Related files: `src/main.ts`, `src/ui/components/game-over-overlay.component.ts`, `src/ui/components/leaderboard-panel.component.ts`, `public/manifest.json`
